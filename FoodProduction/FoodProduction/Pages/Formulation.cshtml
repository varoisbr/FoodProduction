@page
@model FormulationModel
@{
    ViewData["Title"] = "Formulation Calculator";
}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h1 class="mb-4">Product Formulation Calculator</h1>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Select Product & Calculate</h5>
                </div>
                <div class="card-body">
                    <form method="post" class="row g-3">
                        <div class="col-md-6">
                            <label for="selectedProductId" class="form-label">Product</label>
                            <select class="form-select" id="selectedProductId" name="selectedProductId" required>
                                <option value="">-- Select a Product --</option>
                                @foreach (var product in Model.Products)
                                {
                                    <option value="@product.Id" selected="@(Model.SelectedProductId == product.Id)">
                                        @product.Name
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="targetWeight" class="form-label">Target Weight (KG)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="targetWeight" name="targetWeight"
                                       value="@Model.TargetWeight" step="0.01" min="0" required />
                                <button type="submit" class="btn btn-primary">Calculate</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            @if (Model.FormulationResult != null)
            {
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">@Model.FormulationResult.ProductName - Formulation Result</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            <strong>Target Weight:</strong> @Model.FormulationResult.TargetWeightKg kg
                            | <strong>Calculated on:</strong> @DateTime.Now.ToString("yyyy-MM-dd HH:mm")
                        </p>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Ingredient</th>
                                        <th class="text-center">Ratio (%)</th>
                                        <th class="text-end">Weight (kg)</th>
                                        <th class="text-end">Cost/kg</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ingredient in Model.FormulationResult.Ingredients)
                                    {
                                        <tr>
                                            <td>@ingredient.IngredientName</td>
                                            <td class="text-center">@ingredient.Ratio.ToString("F2")%</td>
                                            <td class="text-end">@ingredient.CalculatedWeightKg.ToString("F4")</td>
                                            <td class="text-end">@ingredient.CostPerKg.ToString("C2")</td>
                                            <td class="text-end"><strong>@ingredient.SubtotalCost.ToString("C2")</strong></td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="table-light fw-bold">
                                        <td colspan="4" class="text-end">TOTAL ESTIMATED COST:</td>
                                        <td class="text-end text-success">
                                            @Model.FormulationResult.TotalEstimatedCost.ToString("C2")
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <div class="d-flex gap-2 mt-3">
                            <form method="post" asp-page-handler="ExportPdf" style="display:inline;">
                                <input type="hidden" name="productId" value="@Model.SelectedProductId" />
                                <input type="hidden" name="targetWeight" value="@Model.TargetWeight" />
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-file-pdf"></i> Export as PDF
                                </button>
                            </form>

                            <form method="post" asp-page-handler="ExportCsv" style="display:inline;">
                                <input type="hidden" name="productId" value="@Model.SelectedProductId" />
                                <input type="hidden" name="targetWeight" value="@Model.TargetWeight" />
                                <button type="submit" class="btn btn-info">
                                    <i class="bi bi-file-csv"></i> Export as CSV
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            }
            else if (Model.SelectedProductId > 0)
            {
                <div class="alert alert-info" role="alert">
                    Enter a target weight and click "Calculate" to see the formulation.
                </div>
            }
        </div>
    </div>
</div>
